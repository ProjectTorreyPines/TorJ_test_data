name: Release Regression Data

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Set version (based on date or commit)
        run: echo "RELEASE_TAG=v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Create archive (excluding README and LICENSE)
        run: |
          mkdir dist
          tar --exclude='README.md' --exclude='LICENSE' -czf dist/data.tar.gz .

      - name: Set up Julia
        uses: julia-actions/setup-julia@v1
        with:
          version: '1.10'

      - name: Compute hashes
        run: |
          # Install required Julia packages
          julia -e 'using Pkg; Pkg.add(["Tar", "CodecZlib", "SHA"])'
          
          # Compute both hashes
          julia -e '
          using Tar, CodecZlib, SHA
          
          # Read the tarball
          tarball_data = read("dist/data.tar.gz")
          
          # Compute SHA256 of the tarball itself
          tarball_sha = bytes2hex(sha256(tarball_data))
          
          # Decompress and compute git-tree-sha1 of contents
          decompressed = transcode(GzipDecompressor, tarball_data)
          tree_sha = Tar.tree_hash(IOBuffer(decompressed))
          
          # Create the artifact info in TOML format
          artifact_toml = """
          [data]
          git-tree-sha1 = "$tree_sha"
          
          [[data.download]]
          url = "https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/data.tar.gz"
          sha256 = "$tarball_sha"
          lazy = true
          """
          
          write("dist/Artifacts.toml", artifact_toml)
          '

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Automated release ${{ env.RELEASE_TAG }}"
          files: |
            dist/data.tar.gz
            dist/Artifacts.toml
            dist/hash-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output hashes for reference
        run: |
          echo "Generated Artifacts.toml:"
          cat dist/Artifacts.toml